image: docker:stable

options:
  docker: true

pipelines:
  branches:
    develop:
      - step:
          services:
            - docker
          caches:
            - pip3
            - docker
            - node
            - pip
          script:
            - apk add --quiet py3-pip bash python3 python3-dev
            - apk add --quiet build-base libffi-dev openssl-dev libgcc
            - pip3 install --quiet --cache-dir ~/.pip3/cache --upgrade pip
            - pip3 -V
            - echo $PWD
            - pip3 install --quiet --cache-dir ~/.pip3/cache -r ./services/simcct-server/requirements.txt
            - export PYTHONPATH=./services/simcct-server/:./services/simcct-server/simulation/
            - cd ./services/simcct-server
            - python3 -m unittest tests/test_simulation.py  # Run specific Phase Simulation tests only
            - cd ../../
            - echo $PWD
            - pip3 install --quiet --cache-dir ~/.pip3/cache docker-compose==1.24.0
            - docker-compose -v
            - docker-compose up -d --build
            # This should start the test runner for the API server
            - docker-compose exec -T users-server python manage.py test_coverage
            - docker-compose down

definitions:
  caches:
    pip3: ~/.pip3/cache